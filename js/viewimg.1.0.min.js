(function($){var CONSTANT={HTML5:"html5",FILTER:"filter",BASE:"base",IMG_ERROR:"图片不合法",IMG_SUCCESS:"图片通过"};$.fn.viewimg=function(){var privateFn={init:function(options){var $this=$(this);var _this=this;$.fn.viewimg.options=$.extend({},$.fn.viewimg.options,options);$this.bind("change",function(e){var options=$.fn.viewimg.options;options.targetDiv.html("");var isImg=privateFn.ckImg($.fn.viewimg.options.allowTypes,_this.value);if(isImg==CONSTANT.IMG_ERROR){privateFn.errorControl(options,CONSTANT.IMG_ERROR)}else if(isImg==CONSTANT.IMG_SUCCESS){var fn=privateFn.ckSupport();fn(_this)}})},ckSupport:function(path){var supportRes=publicFn.suportHTML5();if(supportRes==CONSTANT.HTML5)return privateFn.fileRead;else if(supportRes==CONSTANT.FILTER)return privateFn.filterRead;else if(supportRes==CONSTANT.BASE)return privateFn.baseRead},ckImg:function(allowTypes,imgSrc){var i=0;var regext="";var ext=imgSrc.substring(imgSrc.lastIndexOf("."));for(;i<allowTypes.length;i++){if(ext==allowTypes[i]){return CONSTANT.IMG_SUCCESS}}return CONSTANT.IMG_ERROR},errorControl:function(options,message){if(!options.error){alert(message)}else if(typeof(options.error)=="function"){$.fn.viewimg.options.error(message)}else{options.error.html(message)}},fileRead:function(dom){var fileList;var options=$.fn.viewimg.options;fileList=dom.files;for(var i=0;i<fileList.length;i++){var file=fileList[i];var reader=new FileReader();reader.readAsDataURL(file);reader.onload=function(e){var img=new Image();img.src=e.target.result;img.total=e.total;img.onload=function(){privateFn.loadImg(img,CONSTANT.HTML5);img=null}};reader.onprogress=function(){}}},filterRead:function(dom){var options=$.fn.viewimg.options;dom.select();dom.blur();var imgSrc=document.selection.createRange().text;privateFn.loadImg(imgSrc,CONSTANT.FILTER);document.selection.empty()},baseRead:function(dom){var imgSrc=dom.value;var $img=$("<img src='"+imgSrc+"'/>");privateFn.loadImg($img,CONSTANT.BASE)},loadImg:function(img,browserType){var options=$.fn.viewimg.options;if(browserType==CONSTANT.HTML5){options.targetDiv.append(img);privateFn.imgZoom(options.targetDiv.find("img"),CONSTANT.HTML5)}else if(browserType==CONSTANT.FILTER){var $container=options.targetDiv;$container.append('<img id="viewimg_size"/>');var $imgAuto=$("#viewimg_size");var imgAuto=$imgAuto[0];imgAuto.style.display="none";imgAuto.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=img)";imgAuto.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=img;setTimeout(function(){var width=$imgAuto.width();var height=$imgAuto.height();console.log(width);console.log(height);privateFn.imgZoom($imgAuto,CONSTANT.FILTER,img)},options.ie_delay)}else if(browserType==CONSTANT.BASE){options.targetDiv.append(img);privateFn.imgZoom(img,CONSTANT.BASE)}},imgZoom:function($img,browserType,src){var options=$.fn.viewimg.options;if(browserType==CONSTANT.HTML5){if(options.sizingMethod=="img"){$img.show()}else if(options.sizingMethod=="scale"){publicFn.imgScale($img,options.targetDiv)}else if(options.sizingMethod=="stretch"){}}else if(browserType==CONSTANT.FILTER){if(options.sizingMethod=="img"){$img.show()}else if(options.sizingMethod=="stretch"){}else if(options.sizingMethod=="scale"){publicFn.imgScale($img,options.targetDiv,src)}}else if(browserType==CONSTANT.BASE){if(options.sizingMethod=="img"){$img.show()}else if(options.sizingMethod=="stretch"){$img.show()}else if(options.sizingMethod=="scale"){publicFn.imgScale($img,options.targetDiv)}}options.targetDiv.show()}};var method=arguments[0];var array;if(publicFn[method]){method=publicFn[method];array=Array.prototype.slice.call(arguments,1)}else if(typeof(method)=='object'||!method){method=privateFn.init;array=new Array(arguments[0])}else{$.error('Method '+method+' does not exist on jQuery.viewimg');return this}return this.each(function(){method.apply(this,array)})};var publicFn={suportHTML5:function(){if(window.File&&window.FileReader&&window.FileList&&window.Blob){return CONSTANT.HTML5}else if(typeof document.body.style.maxHeight==="undefined"){return CONSTANT.BASE}else{return CONSTANT.FILTER}},imgScale:function($img,$container,src){var imgWidth=$img.width();var imgHeight=$img.height();var containerWidth=$container.width();var containerHeight=$container.height();var scale=imgWidth/imgHeight;if(imgWidth<=containerWidth&imgHeight<=containerHeight){}else if(imgWidth>containerWidth&&imgHeight<=containerHeight){imgWidth=containerWidth;imgHeight=imgWidth/scale}else if(imgHeight>containerHeight&&imgWidth<=containerWidth){imgHeight=containerHeight;imgWidth=imgHeight*scale}else if(imgHeight>containerHeight&&imgWidth>containerWidth){imgHeight=containerHeight;imgWidth=imgHeight*scale;if(imgWidth>containerWidth){imgWidth=containerWidth;imgHeight=imgWidth/scale}}var marginTop=(containerHeight-imgHeight)/2;var marginLeft=(containerWidth-imgWidth)/2;$img.width(imgWidth).height(imgHeight);if(src){$img[0].style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";$img[0].filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=src}$img.css("margin-top",marginTop+"px");$img.css("margin-left",marginLeft+"px");$img.show()}};$.fn.viewimg.options={error:"",targetDiv:"",allowTypes:[".jpg",".png",".bmp",".gif",".jpeg"],sizingMethod:"scale",ie_delay:2000}})(jQuery);